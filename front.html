<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Document</title>
    <meta name="viewport"
        content="width=device-width, initial-scale=1">
    <style>
    .table {
        width: 100%;
        text-align: center;
        font-family: Helvetica, Arial, sans-serif;
    }

    .table tbody tr:nth-child(2n+1) {
        background-color: #eee;
    }

    .table td,
    .table th {
        border: none;
        padding: 5px;
    }

    .table thead tr {
        background-color: #555;
        color: #fff;
    }
    </style>
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.18/c3.min.css">
</head>

<body>
    <div class="container">
        <div id="statsChart"></div>
    </div>
    <br>
    <table id="rawdata"
        class="table"
        cellspacing="0"></table>
    <button id="prev">
        < </button>
            <button id="next">
                >
            </button>
            <select id="limit">
                <option value="15">15</option>
                <option value="30">30</option>
                <option value="50">50</option>
                <option value="100">100</option>
                <option value="300">300</option>
            </select>
            <script src="https://code.jquery.com/jquery-3.2.1.min.js"
                integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
                crossorigin="anonymous"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.18/c3.min.js"></script>
            <script>
            const RSI_THRESHOLD = 30;

            $(document).ready(function() {
                function getData(url) {
                    return new Promise((resolve, reject) => {
                        $.ajax({
                            method: 'GET',
                            url,
                            success: resolve,
                            error: reject
                        })
                    })
                }

                let tbody = $('<tbody/>');
                let thead = $('<thead/>');
                thead.append($('<tr/>').html(`<th>Date</th><th>High</th><th>Low</th><th>Open</th><th>Close</th><th>Volume</th><th>Quote volume</th><th>Weighted average</th>`));
                $('table#rawdata').append(thead).append(tbody);

                function generateTable(data) {
                    let tbody = $('tbody', $('table#rawdata'))
                    tbody.html('');

                    data.forEach((item, i) => {
                        let color = "#222";

                        let found = transactions.find((el) => {
                            return Date.parse(el.date) === Date.parse(item.date)
                        });

                        if (found && found.type === 'buy') {
                            color = '#00dd00';
                        } else if (found && found.type === 'sell') {
                            color = '#dd0000'
                        }

                        let row = $('<tr/>', { style: 'color: ' + color }).html(`<td>${item.date}</td><td>${item.high}</td><td>${item.low}</td><td>${item.open}</td><td>${item.close}</td><td>${item.volume}</td><td>${item.quoteVolume}</td><td>${item.weightedAverage}</td>`);
                        tbody.append(row)
                    });
                }

                function getTableData(paramString) {
                    if (!paramString) paramString = ''
                    getData('http://localhost:8888/raw-data' + paramString)
                        .then((res) => {
                            generateTable(res)
                        })
                        .catch(err => { console.error(err) })
                }


                // pagination
                let params = {
                    offset: 0,
                    limit: 15
                };

                $('#limit').change((ev) => {
                    params.limit = +ev.target.value;
                    params.offset = 0
                    getTableData(`?offset=0&limit=${params.limit}`)
                });

                $('#prev').click(function prev() {
                    params.offset = params.offset > params.limit ? params.offset - params.limit : 0;
                    getTableData(`?offset=${params.offset}&limit=${params.limit}`)
                });

                $('#next').click(function next() {
                    params.offset = params.offset + params.limit;
                    getTableData(`?offset=${params.offset}&limit=${params.limit}`)
                });

                let calculatedStats, transactions;
                getData('http://localhost:8888/bbands')
                    .then((bbands) => {
                        calculatedStats = bbands;
                        return getData('http://localhost:8888/transactions');
                    })
                    .then((transacts) => {
                        transactions = transacts;
                        createChart();
                        return getTableData()
                    })
                    .catch(err => { console.error(err) })

                function sortDates(a, b) {
                    return new Date(a) - new Date(b)
                }

                let hasBuy = false;

                function createChart() {
                    let prices = JSON.parse(calculatedStats.prices).reverse(),
                        lowerBand = JSON.parse(calculatedStats.lowerBand),
                        middleBand = JSON.parse(calculatedStats.middleBand),
                        upperBand = JSON.parse(calculatedStats.upperBand),
                        categories = JSON.parse(calculatedStats.dates).sort(sortDates),
                        rsi = JSON.parse(calculatedStats.rsi).map(el => el / 1e4)

                    c3.generate({
                        bindto: '#statsChart',
                        size: {
                            width: window.innerWidth - 40,
                            height: 600
                        },
                        padding: { left: 40 },
                        color: {
                            pattern: ['#666666', '#36a2eb', '#ff6384', '#cc65fe', '#0000bb']
                        },
                        data: {
                            columns: [
                                [].concat(['Price'], prices), [].concat(['LowerBand'], lowerBand), [].concat(['MiddleBand'], middleBand), [].concat(['UpperBand'], upperBand), [].concat(['RSI'], rsi),
                            ],
                            type: 'line',
                            color(color, d) {
                                // point color if buy/sell 
                                let found = transactions.find((el) => {
                                    return Date.parse(el.date) === Date.parse(categories[d.index])
                                });

                                if (found && found.type === 'buy') {
                                    return '#00dd00';
                                } else if (found && found.type === 'sell') {
                                    return '#dd0000'
                                }
                                return color
                            }
                        },
                        axis: {
                            x: {
                                type: 'category',
                                tick: {
                                    fit: false,
                                    rotate: 0,
                                    multiline: false,
                                    culling: { max: 6 },
                                },
                                categories
                            }
                        },
                        point: {
                            // point radius if buy/sell - 4 else 0
                            r(d) {
                                if (d.id === 'Price') {
                                    let found = transactions.find((el) => {
                                        return Date.parse(el.date) === Date.parse(categories[d.index])
                                    });

                                    if (found) return 4
                                }
                                return 0
                            }
                        },

                        tooltip: {
                            format: {
                                value(value, ratio, id, index) {
                                    if (id === 'RSI') return value * 1e4
                                    return value;
                                },
                                title(x) {
                                    try {
                                        let arr = categories[x].split('T');
                                        return arr[0] + ' ' + arr[1].slice(0, -5)
                                    } catch (e) {
                                        return categories[x]
                                    }
                                }
                            }
                        },
                        grid: {
                            y: { show: true }
                        },
                        zoom: { enabled: true },
                        transition: { duration: 0 },

                    });
                }
            })
            </script>
</body>

</html>